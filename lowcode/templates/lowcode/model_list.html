<!-- templates/lowcode/model_list.html  -->
{% extends "base.html" %}
{% load static custom_filters %}

{% block title %}动态模型管理 - 低代码平台{% endblock %}

{% block extra_css %}
<style>
    /* 基础全局样式 */
    body {
        background-color: #f8f9fa;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    /* 卡片视图样式优化 */
    .model-card {
        transition: all 0.3s ease;
        border: 1px solid #e2e8f0;
        height: 100%;
        border-radius: 0.75rem;
        background-color: #ffffff;
        overflow: hidden;
    }

    .model-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
        border-color: #3b82f6;
    }

    .model-card .card-body {
        display: flex;
        flex-direction: column;
        padding: 1.25rem;
    }

    .model-card .card-title {
        font-size: 1.0625rem;
        font-weight: 600;
        color: #1a202c;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .model-card .card-title a {
        color: #1a202c;
        transition: color 0.2s ease;
    }

    .model-card .card-title a:hover {
        color: #3b82f6;
        text-decoration: none;
    }

    /* 状态标签样式优化 */
    .status-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .status-badge.bg-success {
        background-color: #dcfce7;
        color: #166534;
        border: 1px solid #bbf7d0;
    }

    .status-badge.bg-danger {
        background-color: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }

    .status-badge.bg-primary {
        background-color: #dbeafe;
        color: #1e40af;
        border: 1px solid #bfdbfe;
    }

    .status-badge.bg-gray-300 {
        background-color: #f3f4f6;
        color: #4b5563;
        border: 1px solid #e5e7eb;
    }

    /* 表格样式优化 */
    .table {
        margin-bottom: 0;
        color: #2d3748;
        border-collapse: separate;
        border-spacing: 0;
        border-radius: 0.75rem;
        overflow: hidden;
    }

    .table th {
        white-space: nowrap;
        font-weight: 600;
        color: #4a5568;
        background-color: #f8fafc;
        border-bottom: 2px solid #e2e8f0;
        padding: 0.875rem 1rem;
        text-align: left;
    }

    .table td {
        padding: 0.875rem 1rem;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: middle;
    }

    .table-hover tbody tr:hover td {
        background-color: #f0f9ff;
        transition: background-color 0.2s ease;
    }

    .table-striped tbody tr:nth-of-type(odd) {
        background-color: #f8fafc;
    }

    /* 搜索区域响应式优化 */
    .search-wrapper {
        max-width: 400px;
        margin-left: auto;
        width: 100%;
    }

    /* 按钮样式优化 */
    .btn {
        border-radius: 0.375rem;
        padding: 0.5rem 0.75rem;
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .btn-outline-secondary {
        background-color: #ffffff;
        border: 1px solid #e2e8f0;
        color: #475569;
    }

    .btn-outline-secondary:hover,
    .btn-outline-secondary.active {
        background-color: #f1f5f9;
        border-color: #94a3b8;
        color: #334155;
    }

    .btn-primary {
        background-color: #3b82f6;
        color: #ffffff;
        border: none;
    }

    .btn-primary:hover {
        background-color: #2563eb;
        color: #ffffff;
        box-shadow: 0 0.25rem 0.5rem rgba(59, 130, 246, 0.2);
        transform: translateY(-1px);
    }

    .btn-sm {
        padding: 0.375rem 0.5rem;
        font-size: 0.8125rem;
    }

    .btn-outline-danger {
        color: #dc2626;
        border-color: #fecaca;
    }

    .btn-outline-danger:hover {
        background-color: #fef2f2;
        border-color: #fecaca;
        color: #b91c1c;
    }

    /* 视图切换按钮组 */
    .view-switch-group .btn {
        border-radius: 0.375rem !important;
        margin-right: 0.25rem;
    }

    .view-switch-group .btn:last-child {
        margin-right: 0;
    }

    /* 空状态优化 */
    .empty-state {
        text-align: center;
        padding: 4rem 1rem;
        color: #64748b;
        margin-top: 2rem;
        background-color: #f8fafc;
        border-radius: 0.75rem;
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1.25rem;
        opacity: 0.4;
        color: #94a3b8;
    }

    .empty-state h4 {
        font-size: 1.125rem;
        font-weight: 600;
        color: #475569;
        margin-bottom: 0.75rem;
    }

    .empty-state p {
        font-size: 0.9375rem;
        margin-bottom: 1.5rem;
        line-height: 1.6;
    }

    /* 加载状态优化 */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.85);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        opacity: 0;
        visibility: hidden;
    }

    .loading-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
        border-width: 0.25rem;
        border-color: #3b82f6;
        border-right-color: transparent;
    }

    /* 数据统计标签优化 */
    .stat-badge {
        font-size: 0.7rem;
        padding: 0.15rem 0.4rem;
        margin-left: 0.3rem;
    }

    /* 页面头部样式 */
    .page-header {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.75rem;
    }

    .page-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1a202c;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .page-title i {
        color: #3b82f6;
        font-size: 1.5rem;
    }

    .data-count-badge {
        background-color: #3b82f6 !important;
        font-weight: 500;
        padding: 0.25rem 0.6rem;
        font-size: 0.875rem;
    }

    /* 搜索框优化 */
    .input-group {
        border-radius: 0.5rem;
        overflow: hidden;
    }

    .form-control {
        border: 1px solid #e2e8f0;
        border-right: none;
        padding: 0.625rem 0.875rem;
        font-size: 0.9375rem;
        transition: all 0.2s ease;
    }

    .form-control:focus {
        border-color: #60a5fa;
        box-shadow: 0 0 0 0.25rem rgba(96, 165, 250, 0.2);
        outline: none;
    }

    .input-group .btn {
        border-radius: 0;
    }

    .input-group .btn:last-child {
        border-top-right-radius: 0.5rem;
        border-bottom-right-radius: 0.5rem;
    }

    /* 提示框样式优化 */
    .alert {
        border-radius: 0.5rem;
        padding: 0.875rem 1rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        border: none;
    }

    .alert-success {
        background-color: #f0fdf4;
        color: #166534;
    }

    .alert-error {
        background-color: #fef2f2;
        color: #991b1b;
    }

    .alert .btn-close {
        margin-left: auto;
    }

    /* 模态框样式优化 */
    .modal-sm .modal-content {
        border-radius: 0.75rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
        border: none;
    }

    .modal-header {
        border-bottom: 1px solid #f1f5f9;
        padding: 1rem 1.25rem;
    }

    .modal-title {
        font-size: 1.0625rem;
        font-weight: 600;
        color: #1a202c;
    }

    .modal-body {
        padding: 1.25rem;
        font-size: 0.9375rem;
        color: #475569;
    }

    .modal-footer {
        border-top: 1px solid #f1f5f9;
        padding: 1rem 1.25rem;
        gap: 0.75rem;
    }

    /* 响应式调整 */
    @media (max-width: 992px) {
        .search-wrapper {
            max-width: 300px;
        }
    }

    @media (max-width: 768px) {
        .page-header {
            align-items: flex-start;
        }

        .search-wrapper {
            max-width: 100%;
            margin-left: 0;
        }

        .table-responsive {
            font-size: 0.875rem;
        }

        .table th,
        .table td {
            padding: 0.75rem 0.5rem;
        }

        .model-card .card-body {
            padding: 1rem;
        }
    }

    @media (max-width: 576px) {
        .d-flex.flex-wrap.gap-2 {
            flex-direction: column;
            gap: 0.75rem !important;
        }

        .view-switch-group {
            width: 100%;
        }

        .view-switch-group .btn {
            flex: 1;
            margin-right: 0 !important;
            margin-bottom: 0 !important;
        }

        .model-card-body {
            text-align: center;
        }

        .btn-group-sm {
            justify-content: center !important;
            margin-top: 0.5rem;
        }

        .page-title {
            font-size: 1.125rem;
        }

        .empty-state {
            padding: 3rem 1rem;
        }

        .empty-state i {
            font-size: 3rem;
        }
    }

    /* 自定义提示框样式 */
    .custom-toast {
        position: fixed;
        top: 1.5rem;
        right: 1.5rem;
        z-index: 9999;
        max-width: 300px;
        border-radius: 0.5rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        overflow: hidden;
        transition: all 0.3s ease;
        transform: translateY(-100px);
        opacity: 0;
    }

    .custom-toast.show {
        transform: translateY(0);
        opacity: 1;
    }

    .toast-body {
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        line-height: 1.5;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .toast-success .toast-body {
        background-color: #f0fdf4;
        color: #166534;
    }

    .toast-error .toast-body {
        background-color: #fef2f2;
        color: #991b1b;
    }

    /* 代码样式优化 */
    code {
        background-color: #f8fafc;
        color: #dc2626;
        padding: 0.15rem 0.3rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
    }

    /* 加载中动画 */
    .count-loading {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    /* 危险提示样式 */
    .danger-highlight {
        color: #dc2626;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<!-- 加载遮罩层 -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">加载中...</span>
    </div>
</div>

<main class="container-fluid py-4">
    <!-- 页面头部 -->
    <header class="page-header">
        <h1 class="page-title">
            <i class="bi bi-layer-group" aria-hidden="true"></i>
            动态模型管理
            <span class="badge bg-primary data-count-badge ms-2">{{ model_configs|length }} 个</span>
        </h1>
        <div class="d-flex flex-wrap gap-2 align-items-center">
            <!-- 视图切换 -->
            <div class="btn-group btn-group-sm view-switch-group" role="group" aria-label="切换视图模式">
                <button type="button"
                        class="btn btn-outline-secondary {% if current_view == 'list' %}active btn-primary{% endif %}"
                        data-view="list"
                        aria-pressed="{% if current_view == 'list' %}true{% else %}false{% endif %}"
                        aria-label="切换到列表视图">
                    <i class="bi bi-list-ul" aria-hidden="true"></i> 列表
                </button>
                <button type="button"
                        class="btn btn-outline-secondary {% if current_view == 'card' %}active btn-primary{% endif %}"
                        data-view="card"
                        aria-pressed="{% if current_view == 'card' %}true{% else %}false{% endif %}"
                        aria-label="切换到卡片视图">
                    <i class="bi bi-grid-3x3-gap" aria-hidden="true"></i> 卡片
                </button>
            </div>
            <a href="{% url 'lowcode:model-create' %}" class="btn btn-primary btn-lg" aria-label="新增模型">
                <i class="bi bi-plus-circle  me-2" aria-hidden="true"></i> 新增模型
            </a>
        </div>
    </header>

    <!-- 消息提示 -->
    {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            <i class="bi {% if message.tags == 'success' %}bi-check-circle-fill{% elif message.tags == 'error' %}bi-exclamation-circle-fill{% else %}bi-info-circle-fill{% endif %}"></i>
            <span>{{ message }}</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="关闭提示"></button>
        </div>
        {% endfor %}
    {% endif %}

    <!-- 搜索和功能区 -->
    <div class="card mb-4 border-0 shadow-sm">
        <div class="card-body">
            <div class="d-flex flex-wrap gap-3 align-items-center">
                <!-- 搜索框 -->
                <div class="input-group search-wrapper flex-grow-1 flex-sm-grow-0">
                    <input type="text"
                           class="form-control"
                           id="searchModel"
                           placeholder="搜索模型名称或表名"
                           aria-label="搜索模型"
                           value="{{ search_keyword|default:'' }}"
                           autocomplete="off">
                    <button class="btn btn-outline-secondary" type="button" id="searchBtn" aria-label="执行搜索">
                        <i class="bi bi-search" aria-hidden="true"></i> 搜索
                    </button>
                    <button class="btn btn-outline-secondary" type="button" id="clearSearchBtn" aria-label="清空搜索" style="display: none;">
                        <i class="bi bi-x-lg" aria-hidden="true"></i> 清除
                    </button>
                </div>

                <!-- 批量操作 -->
                <div class="btn-group btn-group-sm ms-auto">
                    <button type="button" class="btn btn-outline-secondary" id="refreshCountsBtn" aria-label="刷新记录数">
                        <i class="bi bi-arrow-clockwise" aria-hidden="true"></i> 刷新记录数
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 列表视图 -->
    <div id="listView" class="{% if current_view != 'list' %}d-none{% endif %}" aria-live="polite">
        {% if model_configs %}
        <div class="card border-0 shadow-sm overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover align-middle table-striped mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>模型名称</th>
                            <th>数据库表名</th>
                            <th>字段数</th>
                            <th>记录数</th>
                            <th>状态</th>
                            <th>创建时间</th>
                            <th>更新时间</th>
                            <th style="width: 140px;">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for model in model_configs %}
                        <tr class="model-row"
                            data-model-name="{{ model.name }}"
                            data-table-name="{{ model.table_name }}">
                            <td>
                                <a href="{% url 'lowcode:dynamic-model-list' model_name=model.name %}" class="text-decoration-none">
                                    {{ model.name }}
                                </a>
                                {% if not model.has_config %}
                                <span class="badge bg-warning text-dark ms-2">未配置</span>
                                {% endif %}
                            </td>
                            <td><code>{{ model.table_name }}</code></td>
                            <td>{{ model.config.fields.count|default:"-" }}</td>
                            <td>
                                {% if model.record_count == -1 %}
                                <span class="text-danger">统计失败</span>
                                {% else %}
                                <span class="count-value">{{ model.record_count }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="d-flex flex-wrap gap-1">
                                    {% if model.exists_in_db %}
                                        <span class="status-badge bg-success">
                                            <i class="bi bi-check"></i> 已创建
                                        </span>
                                    {% else %}
                                        <span class="status-badge bg-danger">
                                            <i class="bi bi-x"></i> 未创建
                                        </span>
                                    {% endif %}
                                    {% if model.has_config %}
                                        <span class="status-badge bg-primary stat-badge">
                                            <i class="bi bi-sliders"></i> 已配置
                                        </span>
                                    {% else %}
                                        <span class="status-badge bg-gray-300 stat-badge">
                                            <i class="bi bi-sliders"></i> 未配置
                                        </span>
                                    {% endif %}
                                </div>
                            </td>
                            <td>{{ model.create_time|date:"Y-m-d H:i"|default:"-" }}</td>
                            <td>{{ model.update_time|date:"Y-m-d H:i"|default:"-" }}</td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{% url 'lowcode:dynamic-model-list' model_name=model.name %}"
                                       class="btn btn-outline-primary"
                                       aria-label="查看数据"
                                       data-bs-toggle="tooltip"
                                       data-bs-placement="top"
                                       title="数据管理">
                                        <i class="bi bi-list" aria-hidden="true"></i>
                                    </a>
                                    <a href="{% url 'lowcode:dynamic-model-create' model_name=model.name %}"
                                       class="btn btn-outline-success"
                                       aria-label="新增数据"
                                       data-bs-toggle="tooltip"
                                       data-bs-placement="top"
                                       title="新增数据">
                                        <i class="bi bi-plus" aria-hidden="true"></i>
                                    </a>
                                    {% if model.has_config %}
                                    <a href="{% url 'lowcode:model-upgrade' %}"
                                       class="btn btn-outline-secondary"
                                       aria-label="编辑模型"
                                       data-bs-toggle="tooltip"
                                       data-bs-placement="top"
                                       title="编辑模型">
                                        <i class="bi bi-pencil" aria-hidden="true"></i>
                                    </a>
                                    {% endif %}
                                    <!-- 删除按钮 -->
                                    <button type="button"
                                            class="btn btn-outline-danger delete-model-btn"
                                            data-model-name="{{ model.name }}"
                                            data-table-name="{{ model.table_name }}"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="删除模型"
                                            aria-label="删除模型">
                                        <i class="bi bi-trash" aria-hidden="true"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- 卡片视图 -->
    <div id="cardView" class="{% if current_view != 'card' %}d-none{% endif %}" aria-live="polite">
        {% if model_configs %}
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4">
            {% for model in model_configs %}
            <div class="col model-item"
                 data-model-name="{{ model.name }}"
                 data-table-name="{{ model.table_name }}">
                <div class="card model-card h-100">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title mb-2 d-flex align-items-center">
                            <a href="{% url 'lowcode:dynamic-model-list' model_name=model.name %}" class="text-decoration-none flex-grow-1">
                                {{ model.name }}
                            </a>
                            {% if not model.has_config %}
                            <span class="badge bg-warning text-dark ms-2">未配置</span>
                            {% endif %}
                        </h5>
                        <p class="text-muted small mb-2">
                            <i class="bi bi-database me-1"></i> 表名: <code>{{ model.table_name }}</code>
                        </p>
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <div class="flex-grow-1">
                                <i class="bi bi-ui-checks me-1"></i> 字段数: {{ model.config.fields.count|default:"-" }}
                            </div>
                            <div class="flex-grow-1">
                                <i class="bi bi-file-earmark-text me-1"></i> 记录数:
                                {% if model.record_count == -1 %}
                                <span class="text-danger">统计失败</span>
                                {% else %}
                                <span class="count-value">{{ model.record_count }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="mb-3 d-flex flex-wrap gap-2 align-items-center">
                            {% if model.exists_in_db %}
                                <span class="status-badge bg-success">
                                    <i class="bi bi-check"></i> 已创建
                                </span>
                            {% else %}
                                <span class="status-badge bg-danger">
                                    <i class="bi bi-x"></i> 未创建
                                </span>
                            {% endif %}
                            {% if model.has_config %}
                                <span class="status-badge bg-primary">
                                    <i class="bi bi-sliders"></i> 已配置
                                </span>
                            {% else %}
                                <span class="status-badge bg-gray-300">
                                    <i class="bi bi-sliders"></i> 未配置
                                </span>
                            {% endif %}
                            <small class="text-muted ms-auto">
                                <i class="bi bi-calendar me-1"></i> {{ model.create_time|date:"Y-m-d"|default:"-" }}
                            </small>
                        </div>
                        <div class="mt-auto d-flex gap-2">
                            <a href="{% url 'lowcode:dynamic-model-list' model_name=model.name %}"
                               class="btn btn-sm btn-outline-primary flex-grow-1"
                               aria-label="查看数据"
                               data-bs-toggle="tooltip"
                               data-bs-placement="top"
                               title="数据管理">
                                <i class="bi bi-list me-1"></i> 数据管理
                            </a>
                            {% if model.has_config %}
                            <a href="{% url 'lowcode:model-upgrade' %}"
                               class="btn btn-sm btn-outline-secondary"
                               aria-label="编辑模型"
                               data-bs-toggle="tooltip"
                               data-bs-placement="top"
                               title="编辑模型">
                                <i class="bi bi-pencil"></i>
                            </a>
                            {% endif %}
                            <!-- 删除按钮 -->
                            <button type="button"
                                    class="btn btn-sm btn-outline-danger delete-model-btn"
                                    data-model-name="{{ model.name }}"
                                    data-table-name="{{ model.table_name }}"
                                    data-bs-toggle="tooltip"
                                    data-bs-placement="top"
                                    title="删除模型"
                                    aria-label="删除模型">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- 空状态提示 -->
    <div id="emptyState" class="empty-state" role="status" style="display: {% if model_configs|length == 0 %}block{% else %}none{% endif %};">
        <i class="bi bi-inbox"></i>
        <h4 class="mb-2">未找到匹配的模型</h4>
        <p class="text-muted">
            {% if search_keyword %}
            未找到与 "{{ search_keyword }}" 相关的模型，请尝试其他关键词
            {% else %}
            暂无动态模型，请点击"新增模型"按钮创建
            {% endif %}
        </p>
        {% if not search_keyword %}
        <a href="{% url 'lowcode:model-create' %}" class="btn btn-primary mt-3">
            <i class="bi bi-plus-circle me-1"></i> 新增模型
        </a>
        {% else %}
        <a href="javascript:clearSearch()" class="btn btn-outline-secondary mt-3">
            <i class="bi bi-arrow-counterclockwise me-1"></i> 清除搜索
        </a>
        {% endif %}
    </div>
</main>

<!-- 确认操作模态框 -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title h5" id="confirmModalLabel">
                    <i class="bi bi-exclamation-triangle text-warning me-1"></i>确认删除
                </h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                确定要执行此操作吗？
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmActionBtn">确认</button>
            </div>
        </div>
    </div>
</div>

<!-- 提示框容器 -->
<div id="toastContainer"></div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // 元素获取 - 增加空值保护
    const listView = document.getElementById('listView');
    const cardView = document.getElementById('cardView');
    const emptyState = document.getElementById('emptyState');
    const searchInput = document.getElementById('searchModel');
    const searchBtn = document.getElementById('searchBtn');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    const refreshCountsBtn = document.getElementById('refreshCountsBtn');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const confirmModalEl = document.getElementById('confirmModal');
    const confirmModal = confirmModalEl ? new bootstrap.Modal(confirmModalEl) : null;
    const confirmModalBody = document.getElementById('confirmModalBody');
    const confirmActionBtn = document.getElementById('confirmActionBtn');
    const dataCountBadge = document.querySelector('.data-count-badge');

    // 初始化视图：优先从 localStorage 读取，否则默认 list
    let currentView = localStorage.getItem('modelListViewMode') || '{{ current_view|default:"list" }}';
    if (listView && cardView) {
        showView(currentView);
    }

    // 修复Tooltip初始化 - 逐个初始化，跳过无效元素
    function initTooltips() {
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        console.log(`找到Tooltip触发器数量：${tooltipTriggerList.length}`);

        tooltipTriggerList.forEach(function (triggerEl) {
            try {
                // 检查元素是否有效且在DOM中
                if (triggerEl && triggerEl.nodeType === 1 && triggerEl.isConnected) {
                    new bootstrap.Tooltip(triggerEl);
                }
            } catch (e) {
                console.warn("Tooltip初始化失败（跳过）：", e);
            }
        });
    }
    // 延迟初始化，确保DOM完全渲染
    setTimeout(initTooltips, 100);

    // 切换视图函数 - 增加空值保护
    function showView(mode) {
        if (!listView || !cardView) return;

        const isList = mode === 'list';
        listView.classList.toggle('d-none', !isList);
        cardView.classList.toggle('d-none', isList);

        // 更新按钮状态
        document.querySelectorAll('[data-view]').forEach(btn => {
            const isActive = btn.dataset.view === mode;
            btn.classList.toggle('active', isActive);
            btn.classList.toggle('btn-primary', isActive);
            btn.classList.toggle('btn-outline-secondary', !isActive);
            btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        });

        localStorage.setItem('modelListViewMode', mode);
        performSearch(); // 重新应用搜索过滤
    }

    // 绑定视图切换按钮 - 增加空值保护
    document.querySelectorAll('[data-view]').forEach(btn => {
        btn.addEventListener('click', () => showView(btn.dataset.view));
    });

    // 搜索功能 - 增加空值保护
    function performSearch() {
        if (!searchInput || !emptyState || !clearSearchBtn) return;

        const term = searchInput.value.trim().toLowerCase();
        let visibleCount = 0;
        const totalModels = document.querySelectorAll('.model-row, .model-item').length;

        // 处理列表行
        document.querySelectorAll('.model-row').forEach(row => {
            const name = row.dataset.modelName?.toLowerCase() || '';
            const tableName = row.dataset.tableName?.toLowerCase() || '';
            const isVisible = !term || name.includes(term) || tableName.includes(term);
            row.style.display = isVisible ? '' : 'none';
            if (isVisible) visibleCount++;
        });

        // 处理卡片项
        document.querySelectorAll('.model-item').forEach(card => {
            const name = card.dataset.modelName?.toLowerCase() || '';
            const tableName = card.dataset.tableName?.toLowerCase() || '';
            const isVisible = !term || name.includes(term) || tableName.includes(term);
            card.style.display = isVisible ? '' : 'none';
            if (isVisible) visibleCount++;
        });

        // 显示空状态
        emptyState.style.display = (totalModels > 0 && visibleCount === 0) ? 'block' : 'none';

        // 显示/隐藏清空按钮
        clearSearchBtn.style.display = term ? 'block' : 'none';

        // 更新数据计数徽章（搜索状态）
        if (dataCountBadge) {
            if (term) {
                dataCountBadge.innerHTML = `${visibleCount}/${totalModels} 个`;
            } else {
                dataCountBadge.textContent = `${totalModels} 个`;
            }
        }
    }

    // 搜索按钮点击事件 - 增加空值保护
    if (searchBtn) {
        searchBtn.addEventListener('click', performSearch);
    }

    // 清空搜索 - 增加空值保护
    window.clearSearch = function() {
        if (searchInput) {
            searchInput.value = '';
            performSearch();
        }
    }

    if (clearSearchBtn) {
        clearSearchBtn.addEventListener('click', clearSearch);
    }

    // 输入框回车事件 - 增加空值保护
    if (searchInput) {
        searchInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') performSearch();
        });
    }

    // 防抖刷新记录数
    const debouncedRefreshCounts = debounce(refreshRecordCounts, 300);

    // 刷新记录数按钮事件 - 增加空值保护
    if (refreshCountsBtn && confirmModal && confirmModalBody && confirmActionBtn) {
        refreshCountsBtn.addEventListener('click', () => {
            confirmModalBody.textContent = '确定要刷新所有模型的记录数吗？此操作可能需要几秒时间。';
            confirmActionBtn.onclick = () => {
                debouncedRefreshCounts();
                confirmModal.hide();
            };
            confirmModal.show();
        });
    }

    // 刷新记录数函数 - 增加空值保护
    function refreshRecordCounts() {
        showLoading(true);

        fetch("{% url 'lowcode:refresh-dynamic-methods' %}", {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('网络请求失败');
            return response.json();
        })
        .then(data => {
            if (data.code === 200) {
                document.querySelectorAll('.count-value').forEach(el => {
                    el.innerHTML = `
                        <span class="count-loading">
                            <span class="spinner-border spinner-border-sm" role="status" style="width: 0.875rem; height: 0.875rem;"></span>
                            <span class="visually-hidden">加载中...</span>
                        </span>
                    `;
                });
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showToast('刷新失败：' + (data.msg || '未知错误'), 'error');
            }
        })
        .catch(err => {
            console.error('刷新记录数失败:', err);
            showToast('网络错误，刷新失败', 'error');
        })
        .finally(() => {
            showLoading(false);
        });
    }

    // 删除模型逻辑（支持删除表和数据）- 核心修复
    function bindDeleteButtons() {
        console.log("===== 开始绑定删除按钮 =====");
        const deleteButtons = document.querySelectorAll('.delete-model-btn');
        console.log(`找到删除按钮数量：${deleteButtons.length}`);

        deleteButtons.forEach(btn => {
            // 先移除原有事件，避免重复绑定
            btn.removeEventListener('click', handleDeleteClick);
            btn.addEventListener('click', handleDeleteClick);
        });
    }

// 单独的删除点击处理函数 - 便于调试和维护
function handleDeleteClick() {
    const modelName = this.dataset.modelName;
    const tableName = this.dataset.tableName;
    console.log(`===== 触发删除模型 =====`);
    console.log(`模型名称：${modelName} | 数据表名：${tableName}`);

    // 空值检查
    if (!modelName || !confirmModal || !confirmModalBody || !confirmActionBtn) {
        showToast('操作失败：必要元素未找到', 'error');
        return;
    }

    // 确认模态框内容
    confirmModalBody.innerHTML = `
        <div class="mb-2">
            <p class="mb-1">确定要<span class="danger-highlight">永久删除</span>模型 <strong>${modelName}</strong> 吗？</p>
            <p class="small mb-2 text-muted">数据表名：<code>${tableName || '未知'}</code></p>
        </div>
        <div class="alert alert-danger p-2 mb-0 small">
            <i class="bi bi-exclamation-triangle me-1"></i>
            此操作将：<br>
            1. 删除模型配置信息<br>
            2. <strong>删除数据库表及表中所有数据</strong><br>
            3. 清理相关缓存数据<br>
            <span class="danger-highlight">操作不可逆，请谨慎！</span>
        </div>
    `;

    // 更新确认按钮样式
    confirmActionBtn.className = 'btn btn-danger';
    confirmActionBtn.textContent = '确认删除（不可逆）';

    // 确认按钮点击逻辑
    confirmActionBtn.onclick = function() {
        showLoading(true);

        // ✅ 核心修复：正确生成删除URL
        const deleteUrl = "{% url 'lowcode:model-delete' model_name='__MODEL_NAME__' %}".replace('__MODEL_NAME__', encodeURIComponent(modelName));
        console.log(`生成删除URL：${deleteUrl}`);

        // 获取CSRF令牌 - 兼容多种情况
        let csrfToken = '{{ csrf_token }}';
        if (!csrfToken) {
            const match = document.cookie.match(/csrftoken=([^;]+)/);
            csrfToken = match ? match[1] : '';
        }
        console.log(`CSRF令牌：${csrfToken}`);

        // 发送删除请求
        fetch(deleteUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest',
                // 移除Content-Type，让浏览器自动处理
                // 'Content-Type': 'application/json'
            },
            credentials: 'same-origin', // 确保携带登录Cookie
            body: JSON.stringify({}), // 空body，避免Django解析错误
        })
        .then(response => {
            console.log(`响应状态码：${response.status}`);
            if (!response.ok) {
                throw new Error(`HTTP错误：${response.status} ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log(`删除响应数据：`, data);
            if (data.code === 200) {
                showToast(`模型 ${modelName} 已彻底删除（含数据表和数据）`, 'success');
                // 延迟移除DOM，确保后端完成操作
                setTimeout(() => {
                    // 删除所有相关DOM元素
                    document.querySelectorAll(`[data-model-name="${modelName}"]`).forEach(el => el.remove());

                    // 更新计数徽章
                    if (dataCountBadge) {
                        const current = parseInt(dataCountBadge.textContent) || 0;
                        const newCount = Math.max(0, current - 1);
                        const searchTerm = searchInput ? searchInput.value.trim() : '';

                        if (searchTerm) {
                            const totalModels = document.querySelectorAll('.model-row, .model-item').length;
                            dataCountBadge.innerHTML = `${newCount}/${totalModels} 个`;
                        } else {
                            dataCountBadge.textContent = `${newCount} 个`;
                        }
                    }

                    // 检查空状态
                    const visibleModels = document.querySelectorAll('.model-row:not([style*="none"]), .model-item:not([style*="none"])');
                    if (emptyState && visibleModels.length === 0) {
                        emptyState.style.display = 'block';
                    }
                }, 800);
            } else {
                showToast(`删除失败：${data.msg || '未知错误'}`, 'error');
            }
        })
        .catch(err => {
            console.error(`删除失败：`, err);
            showToast(`删除失败：${err.message}`, 'error');
        })
        .finally(() => {
            showLoading(false);
            confirmModal.hide();
            // 重置确认按钮
            confirmActionBtn.className = 'btn btn-primary';
            confirmActionBtn.textContent = '确认';
        });
    };

    // 显示模态框
    confirmModal.show();
}

    // 显示加载状态 - 增加空值保护
    function showLoading(show) {
        if (!loadingOverlay) return;

        if (show) {
            loadingOverlay.classList.add('active');
            document.body.style.pointerEvents = 'none';
            document.body.style.cursor = 'wait';
        } else {
            loadingOverlay.classList.remove('active');
            document.body.style.pointerEvents = 'auto';
            document.body.style.cursor = 'default';
        }
    }

    // 自定义提示框 - 增加空值保护
    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) return;

        // 移除现有提示框
        const existingToast = document.querySelector('.custom-toast');
        if (existingToast) existingToast.remove();

        // 创建新提示框
        const toast = document.createElement('div');
        toast.className = `custom-toast toast-${type} show`;

        const iconMap = {
            success: 'bi-check-circle-fill',
            error: 'bi-exclamation-circle-fill'
        };

        toast.innerHTML = `
            <div class="toast-body">
                <i class="bi ${iconMap[type]}"></i>
                <span>${message}</span>
            </div>
        `;

        toastContainer.appendChild(toast);

        // 自动关闭
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) toast.parentNode.removeChild(toast);
            }, 300);
        }, 4000);
    }

    // 防抖函数
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // 初始化
    if (searchInput && searchInput.value.trim()) {
        performSearch();
    }

    // 延迟绑定删除按钮，确保DOM完全加载
    setTimeout(bindDeleteButtons, 500);

    // 监听模态框关闭事件，重置按钮样式
    if (confirmModalEl) {
        confirmModalEl.addEventListener('hidden.bs.modal', function () {
            if (confirmActionBtn) {
                confirmActionBtn.className = 'btn btn-primary';
                confirmActionBtn.textContent = '确认';
            }
        });
    }

    // 全局错误处理
    window.addEventListener('unhandledrejection', function (event) {
        console.error('未处理的Promise错误:', event.reason);
        showToast('操作失败：发生未预期的错误', 'error');
        showLoading(false);
    });
});
</script>
{% endblock %}