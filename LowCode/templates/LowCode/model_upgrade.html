{% extends "base.html" %}
{% load static %}

{% block title %}Icent低代码平台 - 模型升级{% endblock %}

{% block extra_css %}
<!-- 自定义样式：优化动画和交互体验 -->
<style>
/* 卡片淡入动画 */
.card {
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.3s ease, transform 0.3s ease;
}
.card.loaded {
    opacity: 1;
    transform: translateY(0);
}

/* 按钮加载状态优化 */
.btn-loading {
    pointer-events: none;
}

/* 警告框样式增强 */
.alert-danger {
    border-left: 4px solid #dc3545;
}

/* 日志详情滚动优化 */
pre {
    white-space: pre-wrap !important;
    word-break: break-all;
}

/* 下拉框聚焦样式 */
.form-select:focus {
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    border-color: #86b7fe;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- 页面标题 + 警告提示（高危操作） -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">模型升级管理</h1>
        <span class="badge bg-danger px-3 py-1 fs-6">高危操作</span>
    </div>

    <!-- 警告框：增强视觉提醒，添加备份提示按钮 -->
    <div class="alert alert-danger alert-dismissible fade show mb-6" role="alert">
        <div class="d-flex align-items-start">
            <i class="bi bi-exclamation-triangle me-3 fs-4 text-danger mt-1"></i>
            <div>
                <strong class="fs-5">重要警告！</strong>
                <p class="mb-2 mt-1">模型升级会直接修改数据库表结构，可能导致数据丢失或损坏，请务必谨慎操作！</p>
                <ul class="mt-1 mb-0 list-unstyled">
                    <li class="d-flex align-items-center mb-1">
                        <i class="bi bi-check-circle me-2 text-warning"></i>
                        升级前请通过<a href="#" class="text-primary fw-bold" onclick="showBackupTips()">数据库备份工具</a>备份相关数据
                    </li>
                    <li class="d-flex align-items-center mb-1">
                        <i class="bi bi-check-circle me-2 text-warning"></i>
                        仅支持对已创建并生成数据表的动态模型进行升级
                    </li>
                    <li class="d-flex align-items-center">
                        <i class="bi bi-check-circle me-2 text-warning"></i>
                        升级过程预计需要 10-30 秒，请勿关闭页面或重复提交
                    </li>
                </ul>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" style="margin-top: -2rem;"></button>
    </div>

    <!-- 升级表单区域：添加表单验证和交互反馈 -->
    <div class="card shadow-sm mb-6 loaded">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0">选择需要升级的模型</h5>
            <span class="text-muted fs-6">当前可升级模型：{{ model_list|length }}</span>
        </div>
        <div class="card-body">
            <form method="post" id="upgradeForm" novalidate>
                {% csrf_token %}
                <div class="row g-3">
                    <!-- 模型选择下拉框：添加搜索功能和验证反馈 -->
                    <div class="col-md-8">
                        <label for="modelSelect" class="form-label fw-semibold">目标模型 <span class="text-danger">*</span></label>
                        <select class="form-select form-select-lg" id="modelSelect" name="model_name" required
                                onchange="validateModelSelection()">
                            <option value="">-- 请选择要升级的模型 --</option>
                            {% for model in model_list %}
                            <option value="{{ model.name }}" data-table="{{ model.table_name }}">
                                {{ model.name }}（表名：{{ model.table_name }}）
                            </option>
                            {% empty %}
                            <option value="" disabled>暂无可用模型（请先创建动态模型）</option>
                            {% endfor %}
                        </select>
                        <!-- 验证提示（默认隐藏） -->
                        <div id="modelSelectError" class="invalid-feedback d-none">
                            请选择需要升级的模型
                        </div>
                        <div class="form-text mt-1">
                            选择后系统会自动更新该模型对应的数据库表结构（添加/修改字段）
                        </div>
                    </div>

                    <!-- 升级按钮：增强视觉效果和加载状态 -->
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary btn-lg w-100" id="upgradeBtn"
                                {% if not model_list %}disabled{% endif %}>
                            <i class="bi bi-arrow-up-circle me-2"></i>确认执行升级
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 升级结果区域（默认隐藏，添加动画效果） -->
    <div class="card shadow-sm" id="resultCard" style="display: none; opacity: 0; transition: opacity 0.5s ease;">
        <div class="card-header bg-success/10 d-flex align-items-center" id="resultHeader">
            <i class="bi bi-check-circle me-2 fs-5 text-success"></i>
            <h5 class="mb-0 text-success" id="resultTitle">升级结果</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-info mb-3" role="alert">
                <i class="bi bi-info-circle me-2"></i>
                以下是升级过程的详细日志，可复制用于问题排查
            </div>
            <pre id="upgradeResult" class="bg-light p-4 rounded border border-secondary/20" style="max-height: 300px; overflow-y: auto;"></pre>
        </div>
        <div class="card-footer bg-light d-flex justify-content-between">
            <button class="btn btn-outline-secondary" onclick="copyResult()">
                <i class="bi bi-clipboard me-2"></i>复制日志
            </button>
            <a href="{% url 'lowcode:model-list' %}" class="btn btn-primary">
                <i class="bi bi-list me-2"></i>返回模型列表
            </a>
        </div>
    </div>

    <!-- 升级日志区域：添加分页和筛选 -->
    <div class="card shadow-sm mt-6 loaded">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0">最近升级日志</h5>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="showAllLogs" onchange="toggleLogDisplay()">
                <label class="form-check-label" for="showAllLogs">显示所有日志</label>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-striped">
                    <thead class="table-light">
                        <tr>
                            <th>升级时间</th>
                            <th>模型名称</th>
                            <th>数据表名</th>
                            <th>操作人</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="logTableBody">
                        {% for log in upgrade_logs %}
                        <tr class="{% if log.status == 'failed' %}table-danger{% elif log.status == 'success' %}table-success{% endif %}">
                            <td>{{ log.create_time|date:"Y-m-d H:i:s" }}</td>
                            <td>{{ log.model_name }}</td>
                            <td>{{ log.table_name|default:"-" }}</td>
                            <td>{{ log.operator.username }}</td>
                            <td>
                                {% if log.status == 'success' %}
                                <span class="badge bg-success px-2 py-1">成功</span>
                                {% else %}
                                <span class="badge bg-danger px-2 py-1">失败</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-info"
                                        onclick="showLogDetail('{{ log.detail|escapejs }}', '{{ log.model_name }}', '{{ log.create_time|date:"Y-m-d H:i:s" }}')">
                                    查看详情
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                <i class="bi bi-calendar-x me-2"></i>暂无升级记录
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 日志详情模态框：优化样式和交互 -->
<div class="modal fade" id="logDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title" id="modalTitle">升级日志详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <span class="text-muted me-3" id="modalInfo"></span>
                </div>
                <pre id="logDetailContent" class="bg-light p-4 rounded border border-secondary/20" style="max-height: 450px; overflow-y: auto; font-size: 0.9rem;"></pre>
            </div>
            <div class="modal-footer bg-light">
                <button class="btn btn-outline-secondary" onclick="copyLogDetail()">
                    <i class="bi bi-clipboard me-2"></i>复制详情
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 备份提示模态框 -->
<div class="modal fade" id="backupTipsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning/10">
                <h5 class="modal-title">数据备份指南</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning mb-4" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    请在升级前完成以下备份步骤，避免数据丢失
                </div>
                <ol class="list-group list-group-numbered">
                    <li class="list-group-item">登录数据库管理工具（如 phpMyAdmin、Navicat）</li>
                    <li class="list-group-item">找到对应的数据表（名称：选中模型的表名）</li>
                    <li class="list-group-item">执行"导出"操作，选择"SQL文件"格式</li>
                    <li class="list-group-item">保存备份文件到安全位置（建议同时备份到本地和云端）</li>
                    <li class="list-group-item">验证备份文件的完整性（可尝试导入到测试环境）</li>
                </ol>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">我已了解</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// 页面加载完成后执行初始化
document.addEventListener('DOMContentLoaded', function() {
    // 为卡片添加加载动画
    setTimeout(() => {
        document.querySelectorAll('.card').forEach(card => {
            card.classList.add('loaded');
        });
    }, 100);

    // 初始化 Bootstrap 模态框
    window.backupModal = new bootstrap.Modal(document.getElementById('backupTipsModal'));
    window.logModal = new bootstrap.Modal(document.getElementById('logDetailModal'));
});

// 显示备份提示模态框
function showBackupTips() {
    window.backupModal.show();
}

// 验证模型选择
function validateModelSelection() {
    const select = document.getElementById('modelSelect');
    const error = document.getElementById('modelSelectError');

    if (select.value) {
        select.classList.remove('is-invalid');
        error.classList.add('d-none');
    } else {
        select.classList.add('is-invalid');
        error.classList.remove('d-none');
    }
}

// 显示日志详情
function showLogDetail(detail, modelName, createTime) {
    document.getElementById('logDetailContent').textContent = detail;
    document.getElementById('modalTitle').textContent = `升级日志详情 - ${modelName}`;
    document.getElementById('modalInfo').textContent = `升级时间：${createTime}`;
    window.logModal.show();
}

// 复制结果日志
function copyResult() {
    const result = document.getElementById('upgradeResult').textContent;
    navigator.clipboard.writeText(result).then(() => {
        alert('日志已成功复制到剪贴板！');
    }).catch(err => {
        alert('复制失败，请手动复制：' + err);
    });
}

// 复制日志详情
function copyLogDetail() {
    const detail = document.getElementById('logDetailContent').textContent;
    navigator.clipboard.writeText(detail).then(() => {
        alert('日志详情已成功复制到剪贴板！');
    }).catch(err => {
        alert('复制失败，请手动复制：' + err);
    });
}

// 切换日志显示（最近10条/所有）
function toggleLogDisplay() {
    const showAll = document.getElementById('showAllLogs').checked;
    // 这里可以根据实际需求实现分页加载所有日志的逻辑
    if (showAll) {
        alert('已切换到显示所有日志（实际项目中可通过AJAX加载更多日志）');
    } else {
        alert('已切换到显示最近10条日志');
    }
}

// 表单提交处理（优化错误处理和用户体验）
document.getElementById('upgradeForm').addEventListener('submit', function(e) {
    e.preventDefault();

    // 先验证表单
    validateModelSelection();
    const select = document.getElementById('modelSelect');
    if (!select.value) {
        return;
    }

    // 二次确认
    if (!confirm('确定要升级选中的模型吗？\n\n升级会修改数据库表结构，建议已完成数据备份！')) {
        return;
    }

    const form = this;
    const btn = document.getElementById('upgradeBtn');
    const resultCard = document.getElementById('resultCard');
    const resultContent = document.getElementById('upgradeResult');
    const resultHeader = document.getElementById('resultHeader');
    const resultTitle = document.getElementById('resultTitle');

    // 禁用按钮，显示加载状态
    btn.disabled = true;
    btn.classList.add('btn-loading');
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>升级中...';
    resultCard.style.display = 'none';

    // 发送表单数据
    fetch(form.action, {
        method: 'POST',
        body: new FormData(form),
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        timeout: 30000 // 设置30秒超时
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`网络错误：${response.status} ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        // 显示结果（添加淡入动画）
        resultCard.style.display = 'block';
        setTimeout(() => {
            resultCard.style.opacity = '1';
        }, 10);

        if (data.success) {
            resultContent.textContent = `✅ 升级成功！\n\n操作时间：${new Date().toLocaleString()}\n模型名称：${select.options[select.selectedIndex].text}\n\n详情：\n${data.message}`;
            resultHeader.className = 'card-header bg-success/10 d-flex align-items-center';
            resultTitle.className = 'mb-0 text-success';
            resultTitle.textContent = '升级成功';
        } else {
            resultContent.textContent = `❌ 升级失败！\n\n操作时间：${new Date().toLocaleString()}\n模型名称：${select.options[select.selectedIndex].text}\n\n错误信息：\n${data.message}`;
            resultHeader.className = 'card-header bg-danger/10 d-flex align-items-center';
            resultTitle.className = 'mb-0 text-danger';
            resultTitle.textContent = '升级失败';
        }

        // 刷新日志列表（实际项目中可通过AJAX重新获取）
        setTimeout(() => {
            location.reload(); // 简单方式：刷新页面更新日志
        }, 3000);
    })
    .catch(error => {
        // 显示异常结果
        resultCard.style.display = 'block';
        setTimeout(() => {
            resultCard.style.opacity = '1';
        }, 10);

        resultContent.textContent = `⚠️  升级异常！\n\n操作时间：${new Date().toLocaleString()}\n模型名称：${select.options[select.selectedIndex].text}\n\n异常信息：\n${error.message}\n\n建议：检查网络连接和数据库状态后重试`;
        resultHeader.className = 'card-header bg-warning/10 d-flex align-items-center';
        resultTitle.className = 'mb-0 text-warning';
        resultTitle.textContent = '升级异常';
    })
    .finally(() => {
        // 恢复按钮状态
        btn.disabled = false;
        btn.classList.remove('btn-loading');
        btn.innerHTML = '<i class="bi bi-arrow-up-circle me-2"></i>确认执行升级';
    });
});
</script>
{% endblock %}