{% extends "base.html" %}
{% load static %}

{% block title %}Icent AI原生低代码平台 - 创建动态模型{% endblock %}

{% block extra_css %}
<style>
.card {
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.3s ease, transform 0.3s ease;
}
.card.loaded {
    opacity: 1;
    transform: translateY(0);
}
.btn-loading {
    pointer-events: none;
}
.alert-danger {
    border-left: 4px solid #dc3545;
}
/* 字段行样式 */
.field-row {
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    background-color: #f8fafc;
}
.field-remove-btn {
    margin-top: 2.5rem;
}
/* 字段类型下拉框样式 */
.field-type-select {
    max-width: 200px;
}
/* 必填标记 */
.required-mark {
    color: #dc3545;
}
/* 表单校验错误样式增强 */
.is-invalid {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.1) !important;
}
.invalid-feedback {
    color: #dc3545;
    font-size: 0.875rem;
    margin-top: 0.25rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">创建动态模型</h1>
        <span class="badge bg-primary px-3 py-1 fs-6">基础配置 + 字段定义</span>
    </div>

    <!-- 提示框 -->
    <div class="alert alert-info alert-dismissible fade show mb-6" role="alert">
        <div class="d-flex align-items-start">
            <i class="bi bi-info-circle me-3 fs-4 text-primary mt-1"></i>
            <div>
                <strong class="fs-5">创建说明</strong>
                <p class="mb-2 mt-1">创建模型将自动生成对应的数据库表结构，请填写合法的模型名称和表名，并定义字段信息</p>
                <ul class="mt-1 mb-0 list-unstyled">
                    <li class="d-flex align-items-center mb-1">
                        <i class="bi bi-check-circle me-2 text-primary"></i>
                        模型名称需为合法Python标识符（字母、下划线开头，无特殊字符）
                    </li>
                    <li class="d-flex align-items-center mb-1">
                        <i class="bi bi-check-circle me-2 text-primary"></i>
                        表名需为合法数据库标识符，创建后不可修改
                    </li>
                    <li class="d-flex align-items-center">
                        <i class="bi bi-check-circle me-2 text-primary"></i>
                        字段名称需为小写字母+下划线，字段类型请选择合适的数据库类型
                    </li>
                </ul>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" style="margin-top: -2rem;"></button>
    </div>

    <!-- 模型基础配置卡片 -->
    <div class="card shadow-sm mb-6 loaded">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0">模型基础配置</h5>
        </div>
        <div class="card-body">
            <!-- 新增：后端错误提示展示 -->
            {% if form.errors or error_message %}
            <div class="alert alert-danger mb-4">
                <i class="bi bi-exclamation-triangle me-2"></i>
                {% if error_message %}
                    {{ error_message }}
                {% else %}
                    表单提交失败：
                    {% for field, errors in form.errors.items %}
                        {% for error in errors %}
                            {{ field }}: {{ error }}
                        {% endfor %}
                    {% endfor %}
                {% endif %}
            </div>
            {% endif %}

            <form method="post" id="createModelForm" novalidate>
                {% csrf_token %}
                <div class="row g-3">
                    <!-- 模型名称输入框 -->
                    <div class="col-md-6">
                        <label for="modelName" class="form-label fw-semibold">模型名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control form-control-lg {% if form.name.errors %}is-invalid{% endif %}"
                               id="modelName" name="name" required
                               value="{{ form.name.value|default:'' }}"
                               placeholder="例如：Product、Order" onblur="validateModelName()">
                        <div id="modelNameError" class="invalid-feedback {% if form.name.errors %}d-block{% else %}d-none{% endif %}">
                            {{ form.name.errors.0|default:"请输入合法的模型名称（字母、下划线开头）" }}
                        </div>
                        <div class="form-text mt-1">
                            用于程序识别，需符合Python标识符规则（不可包含空格、特殊字符）
                        </div>
                    </div>

                    <!-- 数据表名输入框（可自动生成） -->
                    <div class="col-md-6">
                        <label for="tableName" class="form-label fw-semibold">数据表名 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control form-control-lg {% if form.table_name.errors %}is-invalid{% endif %}"
                               id="tableName" name="table_name"
                               value="{{ form.table_name.value|default:'' }}"
                               placeholder="例如：lowcode_product" onblur="validateTableName()">
                        <button type="button" class="btn btn-outline-secondary mt-2" onclick="generateTableName()">
                            <i class="bi bi-magic me-2"></i>自动生成表名
                        </button>
                        <div id="tableNameError" class="invalid-feedback {% if form.table_name.errors %}d-block{% else %}d-none{% endif %}">
                            {{ form.table_name.errors.0|default:"请输入合法的表名（字母、下划线开头）" }}
                        </div>
                    </div>

                    <!-- 关联角色（可选） -->
                    <div class="col-md-12">
                        <label for="modelRoles" class="form-label fw-semibold">可访问角色</label>
                        <select class="form-select form-select-lg" id="modelRoles" name="roles" multiple size="3">
                            {% for role in roles %}
                            <option value="{{ role.id }}" {% if role.id in form.roles.value|default:'' %}selected{% endif %}>
                                {{ role.name }}（{{ role.code }}）
                            </option>
                            {% empty %}
                            <option value="" disabled>暂无角色，请先创建角色</option>
                            {% endfor %}
                        </select>
                        <div class="form-text mt-1">
                            选择可访问该模型的角色，未选择则仅管理员可访问
                        </div>
                    </div>
                </div>

                <!-- 字段定义区域 -->
                <div class="mt-8">
                    <h5 class="fw-semibold mb-4">
                        <i class="bi bi-columns me-2 text-primary"></i>字段定义
                        <span class="text-muted fs-6">(至少添加一个字段)</span>
                    </h5>

                    <!-- 字段列表容器 -->
                    <div id="fieldsContainer" class="mb-4">
                        <!-- 初始默认字段行 -->
                        {% if field_forms|length == 0 %}
                        <div class="field-row" data-index="0">
                            <div class="row g-3">
                                <div class="col-md-2">
                                    <label class="form-label fw-semibold">字段名称 <span class="required-mark">*</span></label>
                                    <input type="text" class="form-control field-name" name="field_names[]"
                                           placeholder="例如：name、price" onblur="validateFieldName(this)">
                                    <div class="invalid-feedback field-name-error">
                                        字段名需以字母/下划线开头，仅含小写字母、数字、下划线
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-semibold">字段类型 <span class="required-mark">*</span></label>
                                    <select class="form-select field-type-select field-type" name="field_types[]" required>
                                        <option value="">请选择</option>
                                        <option value="char">字符串 (CHAR)</option>
                                        <option value="varchar">变长字符串 (VARCHAR)</option>
                                        <option value="int">整数 (INT)</option>
                                        <option value="bigint">长整数 (BIGINT)</option>
                                        <option value="decimal">小数 (DECIMAL)</option>
                                        <option value="text">文本 (TEXT)</option>
                                        <option value="datetime">日期时间 (DATETIME)</option>
                                        <option value="boolean">布尔 (BOOLEAN)</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-semibold">字段长度</label>
                                    <input type="number" class="form-control field-length" name="field_lengths[]"
                                           placeholder="例如：255" min="1" oninput="validateFieldLength(this)">
                                    <div class="invalid-feedback field-length-error">
                                        长度需为正整数
                                    </div>
                                    <div class="form-text mt-1">
                                        字符串类型必填，其他类型可选
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-semibold">是否必填</label>
                                    <select class="form-select field-required" name="field_required[]">
                                        <option value="True">是</option>
                                        <option value="False">否</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-semibold">默认值</label>
                                    <input type="text" class="form-control field-default" name="field_defaults[]"
                                           placeholder="可选">
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label fw-semibold">字段备注</label>
                                    <input type="text" class="form-control field-comment" name="field_comments[]"
                                           placeholder="可选">
                                </div>
                                <div class="col-md-1 field-remove-btn">
                                    <button type="button" class="btn btn-danger" onclick="removeFieldRow(this)" disabled>
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% else %}
                            <!-- 回显已填写的字段 -->
                            {% for field_form in field_forms %}
                            <div class="field-row" data-index="{{ forloop.counter0 }}">
                                <div class="row g-3">
                                    <div class="col-md-2">
                                        <label class="form-label fw-semibold">字段名称 <span class="required-mark">*</span></label>
                                        <input type="text" class="form-control field-name {% if field_form.name.errors %}is-invalid{% endif %}"
                                               name="field_names[]" value="{{ field_form.name.value|default:'' }}"
                                               placeholder="例如：name、price" onblur="validateFieldName(this)">
                                        <div class="invalid-feedback field-name-error {% if field_form.name.errors %}d-block{% endif %}">
                                            {{ field_form.name.errors.0|default:"字段名需以字母/下划线开头，仅含小写字母、数字、下划线" }}
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label fw-semibold">字段类型 <span class="required-mark">*</span></label>
                                        <select class="form-select field-type-select field-type {% if field_form.type.errors %}is-invalid{% endif %}"
                                                name="field_types[]" required>
                                            <option value="">请选择</option>
                                            <option value="char" {% if field_form.type.value == 'char' %}selected{% endif %}>字符串 (CHAR)</option>
                                            <option value="varchar" {% if field_form.type.value == 'varchar' %}selected{% endif %}>变长字符串 (VARCHAR)</option>
                                            <option value="int" {% if field_form.type.value == 'int' %}selected{% endif %}>整数 (INT)</option>
                                            <option value="bigint" {% if field_form.type.value == 'bigint' %}selected{% endif %}>长整数 (BIGINT)</option>
                                            <option value="decimal" {% if field_form.type.value == 'decimal' %}selected{% endif %}>小数 (DECIMAL)</option>
                                            <option value="text" {% if field_form.type.value == 'text' %}selected{% endif %}>文本 (TEXT)</option>
                                            <option value="datetime" {% if field_form.type.value == 'datetime' %}selected{% endif %}>日期时间 (DATETIME)</option>
                                            <option value="boolean" {% if field_form.type.value == 'boolean' %}selected{% endif %}>布尔 (BOOLEAN)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label fw-semibold">字段长度</label>
                                        <input type="number" class="form-control field-length {% if field_form.length.errors %}is-invalid{% endif %}"
                                               name="field_lengths[]" value="{{ field_form.length.value|default:'' }}"
                                               placeholder="例如：255" min="1" oninput="validateFieldLength(this)">
                                        <div class="invalid-feedback field-length-error {% if field_form.length.errors %}d-block{% endif %}">
                                            {{ field_form.length.errors.0|default:"长度需为正整数" }}
                                        </div>
                                        <div class="form-text mt-1">
                                            字符串类型必填，其他类型可选
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label fw-semibold">是否必填</label>
                                        <select class="form-select field-required" name="field_required[]">
                                            <option value="True" {% if field_form.required.value|default:'True' == 'True' %}selected{% endif %}>是</option>
                                            <option value="False" {% if field_form.required.value == 'False' %}selected{% endif %}>否</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label fw-semibold">默认值</label>
                                        <input type="text" class="form-control field-default" name="field_defaults[]"
                                               value="{{ field_form.default.value|default:'' }}" placeholder="可选">
                                    </div>
                                    <div class="col-md-1">
                                        <label class="form-label fw-semibold">字段备注</label>
                                        <input type="text" class="form-control field-comment" name="field_comments[]"
                                               value="{{ field_form.comment.value|default:'' }}" placeholder="可选">
                                    </div>
                                    <div class="col-md-1 field-remove-btn">
                                        <button type="button" class="btn btn-danger" onclick="removeFieldRow(this)"
                                                {% if field_forms|length <= 1 %}disabled{% endif %}>
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>

                    <!-- 添加字段按钮 -->
                    <button type="button" class="btn btn-outline-primary mb-4" onclick="addFieldRow()">
                        <i class="bi bi-plus me-2"></i>添加字段
                    </button>
                </div>

                <!-- 提交创建按钮 -->
                <div class="col-md-12 d-flex justify-content-end">
                    <button type="button" class="btn btn-outline-secondary me-3" onclick="window.location.href='{% url 'lowcode:model-list' %}'">
                        <i class="bi bi-arrow-left me-2"></i>取消
                    </button>
                    <button type="submit" class="btn btn-primary btn-lg" id="createBtn">
                        <i class="bi bi-plus-circle me-2"></i>确认创建模型
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// 页面初始化
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        document.querySelectorAll('.card').forEach(card => {
            card.classList.add('loaded');
        });
    }, 100);

    // 初始化删除按钮状态
    updateRemoveButtons();
});

// 验证模型名称
function validateModelName() {
    const input = document.getElementById('modelName');
    const error = document.getElementById('modelNameError');
    const regex = /^[a-zA-Z_][a-zA-Z0-9_]*$/;

    if (regex.test(input.value.trim())) {
        input.classList.remove('is-invalid');
        error.classList.add('d-none');
        return true;
    } else {
        input.classList.add('is-invalid');
        error.classList.remove('d-none');
        return false;
    }
}

// 验证表名
function validateTableName() {
    const input = document.getElementById('tableName');
    const error = document.getElementById('tableNameError');
    const regex = /^[a-zA-Z_][a-zA-Z0-9_]*$/;

    if (regex.test(input.value.trim())) {
        input.classList.remove('is-invalid');
        error.classList.add('d-none');
        return true;
    } else {
        input.classList.add('is-invalid');
        error.classList.remove('d-none');
        return false;
    }
}

// 自动生成表名
function generateTableName() {
    const modelName = document.getElementById('modelName').value.trim().toLowerCase();
    if (modelName) {
        const tableName = `lowcode_${modelName}`;
        document.getElementById('tableName').value = tableName;
        validateTableName();
    } else {
        alert('请先输入模型名称');
    }
}

// 验证字段名称
function validateFieldName(input) {
    const error = input.nextElementSibling;
    // 字段名规则：小写字母、数字、下划线，以字母/下划线开头
    const regex = /^[a-z_][a-z0-9_]*$/;

    if (regex.test(input.value.trim())) {
        input.classList.remove('is-invalid');
        error.classList.add('d-none');
        return true;
    } else {
        input.classList.add('is-invalid');
        error.classList.remove('d-none');
        return false;
    }
}

// 验证字段长度
function validateFieldLength(input) {
    const error = input.nextElementSibling;

    if (input.value.trim() === '') {
        input.classList.remove('is-invalid');
        error.classList.add('d-none');
        return true;
    }

    const length = parseInt(input.value);
    if (!isNaN(length) && length > 0) {
        input.classList.remove('is-invalid');
        error.classList.remove('d-none');
        return true;
    } else {
        input.classList.add('is-invalid');
        error.classList.remove('d-none');
        return false;
    }
}

// 添加字段行
function addFieldRow() {
    const container = document.getElementById('fieldsContainer');
    const rows = container.querySelectorAll('.field-row');
    const newIndex = rows.length;

    // 创建新字段行
    const newRow = document.createElement('div');
    newRow.className = 'field-row';
    newRow.dataset.index = newIndex;
    newRow.innerHTML = `
        <div class="row g-3">
            <div class="col-md-2">
                <label class="form-label fw-semibold">字段名称 <span class="required-mark">*</span></label>
                <input type="text" class="form-control field-name" name="field_names[]"
                       placeholder="例如：name、price" onblur="validateFieldName(this)">
                <div class="invalid-feedback field-name-error">
                    字段名需以字母/下划线开头，仅含小写字母、数字、下划线
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label fw-semibold">字段类型 <span class="required-mark">*</span></label>
                <select class="form-select field-type-select field-type" name="field_types[]" required>
                    <option value="">请选择</option>
                    <option value="char">字符串 (CHAR)</option>
                    <option value="varchar">变长字符串 (VARCHAR)</option>
                    <option value="int">整数 (INT)</option>
                    <option value="bigint">长整数 (BIGINT)</option>
                    <option value="decimal">小数 (DECIMAL)</option>
                    <option value="text">文本 (TEXT)</option>
                    <option value="datetime">日期时间 (DATETIME)</option>
                    <option value="boolean">布尔 (BOOLEAN)</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label fw-semibold">字段长度</label>
                <input type="number" class="form-control field-length" name="field_lengths[]"
                       placeholder="例如：255" min="1" oninput="validateFieldLength(this)">
                <div class="invalid-feedback field-length-error">
                    长度需为正整数
                </div>
                <div class="form-text mt-1">
                    字符串类型必填，其他类型可选
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label fw-semibold">是否必填</label>
                <select class="form-select field-required" name="field_required[]">
                    <option value="True">是</option>
                    <option value="False">否</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label fw-semibold">默认值</label>
                <input type="text" class="form-control field-default" name="field_defaults[]"
                       placeholder="可选">
            </div>
            <div class="col-md-1">
                <label class="form-label fw-semibold">字段备注</label>
                <input type="text" class="form-control field-comment" name="field_comments[]"
                       placeholder="可选">
            </div>
            <div class="col-md-1 field-remove-btn">
                <button type="button" class="btn btn-danger" onclick="removeFieldRow(this)">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    `;

    container.appendChild(newRow);

    // 启用所有删除按钮（至少保留一行）
    updateRemoveButtons();
}

// 删除字段行
function removeFieldRow(btn) {
    const row = btn.closest('.field-row');
    const container = document.getElementById('fieldsContainer');
    const rows = container.querySelectorAll('.field-row');

    // 至少保留一行
    if (rows.length <= 1) {
        alert('至少需要保留一个字段');
        return;
    }

    row.remove();

    // 更新索引和删除按钮状态
    updateFieldIndexes();
    updateRemoveButtons();
}

// 更新字段行索引
function updateFieldIndexes() {
    const rows = document.querySelectorAll('.field-row');
    rows.forEach((row, index) => {
        row.dataset.index = index;
    });
}

// 更新删除按钮状态
function updateRemoveButtons() {
    const rows = document.querySelectorAll('.field-row');
    rows.forEach((row, index) => {
        const btn = row.querySelector('.field-remove-btn .btn-danger');
        btn.disabled = rows.length <= 1;
    });
}

// 整合版：表单提交前的全量字段校验（合并核心校验逻辑）
function validateAllFields() {
    let isValid = true;

    // 1. 检查至少有一个字段行
    const fieldRows = document.querySelectorAll('.field-row');
    if (fieldRows.length === 0) {
        alert('至少需要添加一个字段');
        return false;
    }

    // 2. 检查每个字段行的必填项
    fieldRows.forEach(row => {
        // 校验字段名称（必填）
        const nameInput = row.querySelector('.field-name');
        if (!nameInput.value.trim()) {
            nameInput.classList.add('is-invalid');
            nameInput.nextElementSibling.textContent = '字段名称不能为空';
            nameInput.nextElementSibling.classList.remove('d-none');
            isValid = false;
        } else if (!validateFieldName(nameInput)) {
            isValid = false;
        }

        // 校验字段类型（必填）
        const typeSelect = row.querySelector('.field-type');
        if (!typeSelect.value) {
            typeSelect.classList.add('is-invalid');
            isValid = false;
        } else {
            typeSelect.classList.remove('is-invalid');

            // 3. 针对字符串类型校验长度（CHAR/VARCHAR必填长度）
            if (typeSelect.value === 'char' || typeSelect.value === 'varchar') {
                const lengthInput = row.querySelector('.field-length');
                if (!lengthInput.value.trim()) {
                    lengthInput.classList.add('is-invalid');
                    lengthInput.nextElementSibling.textContent = '字符串类型必须填写长度';
                    lengthInput.nextElementSibling.classList.remove('d-none');
                    isValid = false;
                } else if (!validateFieldLength(lengthInput)) {
                    isValid = false;
                }
            }
        }

        // 4. 其他类型长度校验（非空时验证数值合法性）
        const lengthInput = row.querySelector('.field-length');
        if (lengthInput.value.trim() && !validateFieldLength(lengthInput)) {
            isValid = false;
        }
    });

    return isValid;
}

// 表单提交处理
document.getElementById('createModelForm').addEventListener('submit', function(e) {
    e.preventDefault();

    // 基础信息验证
    const isNameValid = validateModelName();
    const isTableNameValid = validateTableName();
    // 整合版字段全量校验
    const isFieldsValid = validateAllFields();

    if (!isNameValid || !isTableNameValid || !isFieldsValid) {
        // 滚动到第一个错误字段
        const firstInvalid = document.querySelector('.is-invalid');
        if (firstInvalid) {
            firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
            firstInvalid.focus();
        }
        return;
    }

    // 二次确认
    if (!confirm('确定要创建该模型吗？创建后将自动生成数据库表结构和字段')) {
        return;
    }

    const form = this;
    const btn = document.getElementById('createBtn');

    // 加载状态
    btn.disabled = true;
    btn.classList.add('btn-loading');
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>创建中...';

    // 手动构造FormData，确保CSRF和所有字段正确传递
    const formData = new FormData();
    // 添加CSRF令牌
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    // 添加基础字段
    formData.append('name', document.getElementById('modelName').value.trim());
    formData.append('table_name', document.getElementById('tableName').value.trim());

    // 添加角色（多选）
    const roles = document.getElementById('modelRoles').selectedOptions;
    Array.from(roles).forEach(role => {
        formData.append('roles', role.value);
    });

    // 添加所有字段行数据
    const fieldRows = document.querySelectorAll('.field-row');
    fieldRows.forEach((row, index) => {
        const name = row.querySelector('.field-name').value.trim();
        const type = row.querySelector('.field-type').value;
        const length = row.querySelector('.field-length').value.trim();
        const required = row.querySelector('.field-required').value;
        const defaultValue = row.querySelector('.field-default').value.trim();
        const comment = row.querySelector('.field-comment').value.trim();

        formData.append('field_names[]', name);
        formData.append('field_types[]', type);
        formData.append('field_lengths[]', length);
        formData.append('field_required[]', required);
        formData.append('field_defaults[]', defaultValue);
        formData.append('field_comments[]', comment);
    });

    // 提交数据
    fetch(form.action, {
        method: 'POST',
        body: formData,
        // 重要：不要手动设置Content-Type，让浏览器自动处理multipart/form-data
        credentials: 'same-origin', // 确保Cookie（CSRF）正确传递
        timeout: 30000
    })
    .then(response => {
        if (response.status === 403) {
            throw new Error('CSRF令牌验证失败，请刷新页面重试');
        }
        if (!response.ok) {
            // 尝试解析错误信息
            return response.text().then(text => {
                throw new Error(`请求失败 [${response.status}]：${text.substring(0, 200)}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert(`模型创建成功！将跳转到模型列表页`);
            window.location.href = data.redirect_url || '{% url 'lowcode:model-list' %}';
        } else {
            alert(`创建失败：${data.message || '未知错误'}`);
            // 恢复按钮状态
            btn.disabled = false;
            btn.classList.remove('btn-loading');
            btn.innerHTML = '<i class="bi bi-plus-circle me-2"></i>确认创建模型';
        }
    })
    .catch(error => {
        console.error('提交错误详情：', error);
        alert(`创建异常：${error.message || '网络错误或服务器无响应'}`);
        // 恢复按钮状态
        btn.disabled = false;
        btn.classList.remove('btn-loading');
        btn.innerHTML = '<i class="bi bi-plus-circle me-2"></i>确认创建模型';
    });
});

// 实时移除invalid样式（用户输入时）
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('is-invalid')) {
        e.target.classList.remove('is-invalid');
        const errorEl = e.target.nextElementSibling;
        if (errorEl && errorEl.classList.contains('invalid-feedback')) {
            errorEl.classList.add('d-none');
        }
    }
});

// 字段类型切换时自动校验长度
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('field-type')) {
        const row = e.target.closest('.field-row');
        const lengthInput = row.querySelector('.field-length');
        const lengthError = lengthInput.nextElementSibling;

        // 切换为字符串类型时清空错误提示（但保留必填校验）
        if (e.target.value === 'char' || e.target.value === 'varchar') {
            if (!lengthInput.value.trim()) {
                lengthInput.classList.add('is-invalid');
                lengthError.textContent = '字符串类型必须填写长度';
                lengthError.classList.remove('d-none');
            }
        } else {
            // 非字符串类型清除长度必填校验（保留数值合法性校验）
            if (lengthInput.value.trim() === '') {
                lengthInput.classList.remove('is-invalid');
                lengthError.classList.add('d-none');
            }
        }
    }
});

function checkModelNameExists() {
    const modelName = document.getElementById('modelName').value.trim();
    if (!modelName) return;

    // 发送请求检查模型名称是否已存在
    fetch(`/app/api/check-model-name/?name=${encodeURIComponent(modelName)}`, {
        method: 'GET',
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        const errorEl = document.getElementById('modelNameError');
        if (data.exists) {
            document.getElementById('modelName').classList.add('is-invalid');
            errorEl.textContent = `模型 ${modelName} 已存在，请更换名称`;
            errorEl.classList.remove('d-none');
        } else {
            document.getElementById('modelName').classList.remove('is-invalid');
            errorEl.classList.add('d-none');
        }
    })
    .catch(error => console.error('检查模型名称失败：', error));
}

// 给模型名称输入框绑定失去焦点事件
document.getElementById('modelName').addEventListener('blur', checkModelNameExists);

</script>
{% endblock %}