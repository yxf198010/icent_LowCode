{% extends "base.html" %}
{% load static %}

{% block title %}Icent AI原生低代码平台 - 创建动态模型{% endblock %}

{% block extra_css %}
<!-- 复用升级页样式，无需额外新增 -->
<style>
.card {
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.3s ease, transform 0.3s ease;
}
.card.loaded {
    opacity: 1;
    transform: translateY(0);
}
.btn-loading {
    pointer-events: none;
}
.alert-danger {
    border-left: 4px solid #dc3545;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">创建动态模型</h1>
        <span class="badge bg-primary px-3 py-1 fs-6">基础配置</span>
    </div>

    <!-- 提示框 -->
    <div class="alert alert-info alert-dismissible fade show mb-6" role="alert">
        <div class="d-flex align-items-start">
            <i class="bi bi-info-circle me-3 fs-4 text-primary mt-1"></i>
            <div>
                <strong class="fs-5">创建说明</strong>
                <p class="mb-2 mt-1">创建模型将自动生成对应的数据库表结构，请填写合法的模型名称和表名</p>
                <ul class="mt-1 mb-0 list-unstyled">
                    <li class="d-flex align-items-center mb-1">
                        <i class="bi bi-check-circle me-2 text-primary"></i>
                        模型名称需为合法Python标识符（字母、下划线开头，无特殊字符）
                    </li>
                    <li class="d-flex align-items-center">
                        <i class="bi bi-check-circle me-2 text-primary"></i>
                        表名需为合法数据库标识符，创建后不可修改
                    </li>
                </ul>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" style="margin-top: -2rem;"></button>
    </div>

    <!-- 创建表单区域 -->
    <div class="card shadow-sm mb-6 loaded">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0">模型基础配置</h5>
        </div>
        <div class="card-body">
            <form method="post" id="createModelForm" novalidate>
                {% csrf_token %}
                <div class="row g-3">
                    <!-- 模型名称输入框 -->
                    <div class="col-md-6">
                        <label for="modelName" class="form-label fw-semibold">模型名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control form-control-lg" id="modelName" name="name" required
                               placeholder="例如：Product、Order" onblur="validateModelName()">
                        <div id="modelNameError" class="invalid-feedback d-none">
                            请输入合法的模型名称（字母、下划线开头）
                        </div>
                        <div class="form-text mt-1">
                            用于程序识别，需符合Python标识符规则（不可包含空格、特殊字符）
                        </div>
                    </div>

                    <!-- 数据表名输入框（可自动生成） -->
                    <div class="col-md-6">
                        <label for="tableName" class="form-label fw-semibold">数据表名 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control form-control-lg" id="tableName" name="table_name"
                               placeholder="例如：lowcode_product" onblur="validateTableName()">
                        <button type="button" class="btn btn-outline-secondary mt-2" onclick="generateTableName()">
                            <i class="bi bi-magic me-2"></i>自动生成表名
                        </button>
                        <div id="tableNameError" class="invalid-feedback d-none">
                            请输入合法的表名（字母、下划线开头）
                        </div>
                    </div>

                    <!-- 关联角色（可选） -->
                    <div class="col-md-12">
                        <label for="modelRoles" class="form-label fw-semibold">可访问角色</label>
                        <select class="form-select form-select-lg" id="modelRoles" name="roles" multiple size="3">
                            {% for role in roles %}
                            <option value="{{ role.id }}">{{ role.name }}（{{ role.code }}）</option>
                            {% empty %}
                            <option value="" disabled>暂无角色，请先创建角色</option>
                            {% endfor %}
                        </select>
                        <div class="form-text mt-1">
                            选择可访问该模型的角色，未选择则仅管理员可访问
                        </div>
                    </div>

                    <!-- 提交创建按钮（核心：创建模型按钮） -->
                    <div class="col-md-12 d-flex justify-content-end">
                        <button type="button" class="btn btn-outline-secondary me-3" onclick="window.location.href='{% url 'lowcode:model-list' %}'">
                            <i class="bi bi-arrow-left me-2"></i>取消
                        </button>
                        <button type="submit" class="btn btn-primary btn-lg" id="createBtn">
                            <i class="bi bi-plus-circle me-2"></i>确认创建模型
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// 页面初始化
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        document.querySelectorAll('.card').forEach(card => {
            card.classList.add('loaded');
        });
    }, 100);
});

// 验证模型名称
function validateModelName() {
    const input = document.getElementById('modelName');
    const error = document.getElementById('modelNameError');
    const regex = /^[a-zA-Z_][a-zA-Z0-9_]*$/;

    if (regex.test(input.value.trim())) {
        input.classList.remove('is-invalid');
        error.classList.add('d-none');
        return true;
    } else {
        input.classList.add('is-invalid');
        error.classList.remove('d-none');
        return false;
    }
}

// 验证表名
function validateTableName() {
    const input = document.getElementById('tableName');
    const error = document.getElementById('tableNameError');
    const regex = /^[a-zA-Z_][a-zA-Z0-9_]*$/;

    if (regex.test(input.value.trim())) {
        input.classList.remove('is-invalid');
        error.classList.add('d-none');
        return true;
    } else {
        input.classList.add('is-invalid');
        error.classList.remove('d-none');
        return false;
    }
}

// 自动生成表名（复用 ModelLowCode 的逻辑：lowcode_模型名小写）
function generateTableName() {
    const modelName = document.getElementById('modelName').value.trim().toLowerCase();
    if (modelName) {
        const tableName = `lowcode_${modelName}`;
        document.getElementById('tableName').value = tableName;
        validateTableName();
    } else {
        alert('请先输入模型名称');
    }
}

// 表单提交处理
document.getElementById('createModelForm').addEventListener('submit', function(e) {
    e.preventDefault();

    // 表单验证
    const isNameValid = validateModelName();
    const isTableNameValid = validateTableName();
    if (!isNameValid || !isTableNameValid) {
        return;
    }

    // 二次确认
    if (!confirm('确定要创建该模型吗？创建后将自动生成数据库表结构')) {
        return;
    }

    const form = this;
    const btn = document.getElementById('createBtn');

    // 加载状态
    btn.disabled = true;
    btn.classList.add('btn-loading');
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>创建中...';

    // 提交数据
    fetch(form.action, {
        method: 'POST',
        body: new FormData(form),
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        timeout: 30000
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`模型创建成功！将跳转到模型列表页`);
            window.location.href = '{% url 'lowcode:model-list' %}';
        } else {
            alert(`创建失败：${data.message}`);
            btn.disabled = false;
            btn.classList.remove('btn-loading');
            btn.innerHTML = '<i class="bi bi-plus-circle me-2"></i>确认创建模型';
        }
    })
    .catch(error => {
        alert(`创建异常：${error.message}`);
        btn.disabled = false;
        btn.classList.remove('btn-loading');
        btn.innerHTML = '<i class="bi bi-plus-circle me-2"></i>确认创建模型';
    });
});
</script>
{% endblock %}